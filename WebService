
from flask import Flask, request, jsonify
import cv2

app = Flask(__name__)

class ParkingSpaceDetector:
    def __init__(self, image_path, roi_list):
        self.image_path = image_path
        self.image = cv2.imread(image_path)
        self.roi_list = roi_list
        self.results = None  # Variable para almacenar los resultados

    def preprocess_image(self):
        self.resized_image = self.resize_image(self.image)
        self.gray = cv2.cvtColor(self.resized_image, cv2.COLOR_BGR2GRAY)
        self.blurred = cv2.GaussianBlur(self.gray, (5, 5), 0)
        self.thresh = cv2.threshold(self.blurred, 130, 255, cv2.THRESH_BINARY_INV)[1]  # Invierte la umbralización

    def resize_image(self, image):
        max_dimension = 1080
        height, width = image.shape[:2]
        if width > max_dimension or height > max_dimension:
            scale = max_dimension / max(width, height)
            new_width = int(width * scale)
            new_height = int(height * scale)
            return cv2.resize(image, (new_width, new_height))
        return image

    def detect_parking_spaces(self, area_threshold=0):
        results = []

        for roi_coords in self.roi_list:
            x, y, w, h = roi_coords
            roi = self.thresh[y:y+h, x:x+w]
            area = cv2.countNonZero(roi)
            if area > area_threshold:
                status = 1  # Cambiado de "Ocupado" a 1
            else:
                status = 0  # Cambiado de "Libre" a 0
            results.append(status)

        self.results = results  # Almacena los resultados en la variable

        return results

@app.route('/parking_status', methods=['GET'])
def get_parking_status():
    # Procesa la imagen y obtiene el estado de disponibilidad
    detector = ParkingSpaceDetector("Test4.jpg", [(470, 30, 260, 60), (440, 90, 290, 70), (420, 160, 310, 90), (380, 250, 350, 115), (320, 365, 420, 155), (250, 520, 490, 230)])
    detector.preprocess_image()
    detector.detect_parking_spaces(area_threshold=60000)  # Realiza la detección

    # Devuelve los resultados en forma de JSON
    return jsonify({'status': detector.results})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
